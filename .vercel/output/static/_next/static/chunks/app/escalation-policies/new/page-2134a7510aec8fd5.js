(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1498],{22756:function(e,t,n){Promise.resolve().then(n.bind(n,73272))},73272:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return T}});var i=n(57437),a=n(2265),l=n(38543),o=n(77639),r=n(90658),s=n(33101),c=n(41563),u=n(61002),d=n(19352),g=n(22347),h=n(9391),f=n(73088),m=n(95280),x=n(25761),j=n(31835),_=n(67615),v=n(64502),y=n(27554),p=n(36261),Z=n(8319),D=n(99376),z=n(27648),S=n(51442),b=n(11617),w=n(89470),C=n(20599),E=n(85744),k=n(44812);function T(){let e=(0,D.useRouter)(),{session:t}=(0,k.o)(),[n,T]=(0,a.useState)({organization_id:"",name:"",description:"",is_active:!0,notification_rules:[{delay_minutes:0,notification_type:"email",target_type:"user",target_id:"",escalation_level:1}]}),[O,I]=(0,a.useState)([]),[P,F]=(0,a.useState)([]),[N,W]=(0,a.useState)(!1),[A,M]=(0,a.useState)(null),[R,q]=(0,a.useState)(!1),[B,U]=(0,a.useState)({});(0,a.useEffect)(()=>{t&&H()},[t]),(0,a.useEffect)(()=>{n.organization_id&&J(n.organization_id)},[n.organization_id]);let H=async()=>{try{let t=await fetch("/api/organizations");if(t.ok){var e;let n=await t.json();I(n.organizations||[]),(null===(e=n.organizations)||void 0===e?void 0:e.length)===1&&T(e=>({...e,organization_id:n.organizations[0].id}))}}catch(e){console.error("Error fetching organizations:",e)}},J=async e=>{try{let t=await fetch("/api/organizations/".concat(e));if(t.ok){let e=await t.json();F(e.members||[])}}catch(e){console.error("Error fetching organization members:",e)}},L=()=>{let e={};n.organization_id||(e.organization_id="Organization is required"),n.name.trim()||(e.name="Policy name is required"),n.notification_rules.forEach((t,n)=>{t.target_id||(e["rule_".concat(n,"_target")]="Target is required for each notification rule"),t.delay_minutes<0&&(e["rule_".concat(n,"_delay")]="Delay cannot be negative")});let t=n.notification_rules.map(e=>e.escalation_level),i=[...new Set(t)];return t.length!==i.length&&(e.escalation_levels="Each escalation level must be unique"),U(e),0===Object.keys(e).length},V=async t=>{if(t.preventDefault(),!L()){M("Please fix the form errors before submitting");return}W(!0),M(null);try{let t=await fetch("/api/escalation-policies",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to create escalation policy")}await t.json(),q(!0),setTimeout(()=>{e.push("/incidents")},2e3)}catch(e){console.error("Error creating escalation policy:",e),M(e.message)}finally{W(!1)}},G=(e,t)=>{T(n=>({...n,[e]:t})),B[e]&&U(t=>({...t,[e]:""}))},K=(e,t,n)=>{T(i=>({...i,notification_rules:i.notification_rules.map((i,a)=>a===e?{...i,[t]:n}:i)}));let i="rule_".concat(e,"_").concat(t);B[i]&&U(e=>({...e,[i]:""}))},Q=e=>{n.notification_rules.length>1&&T(t=>({...t,notification_rules:t.notification_rules.filter((t,n)=>n!==e)}))},X=e=>{switch(e){case"email":return"Send email notification";case"sms":return"Send SMS text message";case"voice":return"Make voice call";case"slack":return"Send Slack message";case"webhook":return"Send webhook notification";default:return""}};return(0,i.jsx)(E.Z,{children:(0,i.jsxs)(l.Z,{sx:{p:3},children:[(0,i.jsxs)(l.Z,{display:"flex",alignItems:"center",gap:2,mb:4,children:[(0,i.jsx)(o.Z,{component:z.default,href:"/settings",startIcon:(0,i.jsx)(S.Z,{}),variant:"outlined",children:"Back to Settings"}),(0,i.jsx)(r.Z,{variant:"h4",component:"h1",children:"Create Escalation Policy"})]}),A&&(0,i.jsx)(s.Z,{severity:"error",sx:{mb:2},children:A}),(0,i.jsx)(c.Z,{children:(0,i.jsx)(u.Z,{children:(0,i.jsx)("form",{onSubmit:V,children:(0,i.jsxs)(d.Z,{container:!0,spacing:3,children:[(0,i.jsx)(d.Z,{item:!0,xs:12,children:(0,i.jsxs)(g.Z,{fullWidth:!0,error:!!B.organization_id,children:[(0,i.jsx)(h.Z,{children:"Organization *"}),(0,i.jsx)(f.Z,{value:n.organization_id,label:"Organization *",onChange:e=>G("organization_id",e.target.value),children:O.map(e=>(0,i.jsx)(m.Z,{value:e.id,children:e.name},e.id))}),B.organization_id&&(0,i.jsx)(x.Z,{children:B.organization_id})]})}),(0,i.jsx)(d.Z,{item:!0,xs:12,children:(0,i.jsx)(j.Z,{fullWidth:!0,label:"Policy Name *",value:n.name,onChange:e=>G("name",e.target.value),error:!!B.name,helperText:B.name||"A descriptive name for this escalation policy",placeholder:"e.g., Critical Incidents Escalation"})}),(0,i.jsx)(d.Z,{item:!0,xs:12,children:(0,i.jsx)(j.Z,{fullWidth:!0,multiline:!0,rows:3,label:"Description",value:n.description,onChange:e=>G("description",e.target.value),helperText:"Describe when this escalation policy should be used",placeholder:"This policy escalates critical incidents through the engineering team..."})}),(0,i.jsx)(d.Z,{item:!0,xs:12,children:(0,i.jsx)(_.Z,{control:(0,i.jsx)(v.Z,{checked:n.is_active,onChange:e=>G("is_active",e.target.checked)}),label:"Enable this escalation policy"})}),(0,i.jsxs)(d.Z,{item:!0,xs:12,children:[(0,i.jsx)(y.Z,{sx:{my:2}}),(0,i.jsxs)(l.Z,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[(0,i.jsx)(r.Z,{variant:"h6",gutterBottom:!0,children:"Notification Rules"}),(0,i.jsx)(o.Z,{startIcon:(0,i.jsx)(w.Z,{}),onClick:()=>{let e=Math.max(...n.notification_rules.map(e=>e.escalation_level),0)+1;T(t=>({...t,notification_rules:[...t.notification_rules,{delay_minutes:15*e,notification_type:"email",target_type:"user",target_id:"",escalation_level:e}]}))},variant:"outlined",color:"primary",children:"Add Rule"})]}),(0,i.jsx)(r.Z,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Define who gets notified and when during incident escalation"})]}),B.escalation_levels&&(0,i.jsx)(d.Z,{item:!0,xs:12,children:(0,i.jsx)(s.Z,{severity:"error",children:B.escalation_levels})}),n.notification_rules.map((e,t)=>{var a;return(0,i.jsx)(d.Z,{item:!0,xs:12,children:(0,i.jsx)(c.Z,{variant:"outlined",children:(0,i.jsxs)(u.Z,{children:[(0,i.jsxs)(l.Z,{display:"flex",justifyContent:"between",alignItems:"center",mb:2,children:[(0,i.jsxs)(r.Z,{variant:"h6",children:["Escalation Level ",e.escalation_level]}),n.notification_rules.length>1&&(0,i.jsx)(p.Z,{onClick:()=>Q(t),color:"error",size:"small",children:(0,i.jsx)(C.Z,{})})]}),(0,i.jsxs)(d.Z,{container:!0,spacing:2,children:[(0,i.jsx)(d.Z,{item:!0,xs:12,md:3,children:(0,i.jsx)(j.Z,{fullWidth:!0,type:"number",label:"Delay (minutes)",value:e.delay_minutes,onChange:e=>K(t,"delay_minutes",parseInt(e.target.value)||0),error:!!B["rule_".concat(t,"_delay")],helperText:B["rule_".concat(t,"_delay")]||"Time to wait before triggering",inputProps:{min:0,max:1440}})}),(0,i.jsx)(d.Z,{item:!0,xs:12,md:3,children:(0,i.jsxs)(g.Z,{fullWidth:!0,children:[(0,i.jsx)(h.Z,{children:"Notification Type"}),(0,i.jsxs)(f.Z,{value:e.notification_type,label:"Notification Type",onChange:e=>K(t,"notification_type",e.target.value),children:[(0,i.jsx)(m.Z,{value:"email",children:"Email"}),(0,i.jsx)(m.Z,{value:"sms",children:"SMS"}),(0,i.jsx)(m.Z,{value:"voice",children:"Voice Call"}),(0,i.jsx)(m.Z,{value:"slack",children:"Slack"}),(0,i.jsx)(m.Z,{value:"webhook",children:"Webhook"})]}),(0,i.jsx)(x.Z,{children:X(e.notification_type)})]})}),(0,i.jsx)(d.Z,{item:!0,xs:12,md:2,children:(0,i.jsxs)(g.Z,{fullWidth:!0,children:[(0,i.jsx)(h.Z,{children:"Target Type"}),(0,i.jsxs)(f.Z,{value:e.target_type,label:"Target Type",onChange:e=>K(t,"target_type",e.target.value),children:[(0,i.jsx)(m.Z,{value:"user",children:"User"}),(0,i.jsx)(m.Z,{value:"team",children:"Team"}),(0,i.jsx)(m.Z,{value:"on_call",children:"On-Call"})]})]})}),(0,i.jsx)(d.Z,{item:!0,xs:12,md:4,children:(0,i.jsxs)(g.Z,{fullWidth:!0,error:!!B["rule_".concat(t,"_target")],children:[(0,i.jsx)(h.Z,{children:"Target *"}),(0,i.jsxs)(f.Z,{value:e.target_id,label:"Target *",onChange:e=>K(t,"target_id",e.target.value),children:["user"===e.target_type&&P.map(e=>(0,i.jsx)(m.Z,{value:e.id,children:e.name||e.email},e.id)),"team"===e.target_type&&(0,i.jsx)(m.Z,{value:"engineering",children:"Engineering Team"}),"on_call"===e.target_type&&(0,i.jsx)(m.Z,{value:"current_oncall",children:"Current On-Call"})]}),B["rule_".concat(t,"_target")]&&(0,i.jsx)(x.Z,{children:B["rule_".concat(t,"_target")]})]})}),(0,i.jsx)(d.Z,{item:!0,xs:12,children:(0,i.jsx)(l.Z,{sx:{p:1,backgroundColor:"grey.50",borderRadius:1},children:(0,i.jsxs)(r.Z,{variant:"body2",color:"text.secondary",children:[(0,i.jsx)("strong",{children:"Summary:"})," After"," ",e.delay_minutes," minutes, send"," ",e.notification_type," to"," ","user"===e.target_type&&(null===(a=P.find(t=>t.id===e.target_id))||void 0===a?void 0:a.name),"team"===e.target_type&&"Engineering Team","on_call"===e.target_type&&"Current On-Call Person",!e.target_id&&"selected target"]})})})]})]})})},t)}),(0,i.jsx)(d.Z,{item:!0,xs:12,children:(0,i.jsxs)(l.Z,{display:"flex",gap:2,justifyContent:"flex-end",sx:{mt:2},children:[(0,i.jsx)(o.Z,{component:z.default,href:"/incidents",variant:"outlined",disabled:N,children:"Cancel"}),(0,i.jsx)(o.Z,{type:"submit",variant:"contained",startIcon:N?(0,i.jsx)(Z.Z,{size:20}):(0,i.jsx)(b.Z,{}),disabled:N,color:"primary",children:N?"Creating...":"Create Policy"})]})})]})})})})]})})}},85744:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});var i=n(57437),a=n(2265),l=n(8319),o=n(38543),r=n(44812);function s(e){let{children:t}=e,{session:n,sessionStatus:s}=(0,r.o)();return((0,a.useEffect)(()=>{"unauthenticated"===s&&(window.location.href="/api/auth/signin")},[s]),"loading"===s)?(0,i.jsx)(o.Z,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"50vh",children:(0,i.jsx)(l.Z,{})}):n?t:null}},44812:function(e,t,n){"use strict";n.d(t,{f:function(){return s},o:function(){return c}});var i=n(57437),a=n(2265);let l=(0,a.createContext)(),o=()=>{try{if(window.localStorage)return localStorage.getItem("selectedOrganizationId")}catch(e){console.warn("Failed to read from localStorage:",e)}return null},r=e=>{try{if(window.localStorage){if(e)return localStorage.setItem("selectedOrganizationId",e),console.log("✅ Saved to localStorage:",e),!0;return localStorage.removeItem("selectedOrganizationId"),console.log("\uD83D\uDDD1️ Removed from localStorage"),!0}}catch(e){console.warn("Failed to write to localStorage:",e)}return!1};function s(e){let{children:t}=e,{data:n,status:s}=function(){let[e,t]=(0,a.useState)(null),[n,i]=(0,a.useState)("loading");return(0,a.useEffect)(()=>{let e=async()=>{try{i("loading");let e=await fetch("/api/auth/session");if(e.ok){let n=await e.json();t(n),i(n?"authenticated":"unauthenticated")}else t(null),i("unauthenticated")}catch(e){console.error("Error fetching session:",e),t(null),i("unauthenticated")}};e();let n=setInterval(e,3e5);return()=>clearInterval(n)},[]),{data:e,status:n}}(),[c,u]=(0,a.useState)(null),[d,g]=(0,a.useState)([]),[h,f]=(0,a.useState)(!1),[m,x]=(0,a.useState)(null),[j,_]=(0,a.useState)(!1);(0,a.useEffect)(()=>{_(!0)},[]),(0,a.useEffect)(()=>{if(j&&d.length>0&&!c){console.log("\uD83D\uDD0D Client-side restoration check...");let e=o();if(e){let t=d.find(t=>t.id===e);t?(console.log("\uD83D\uDD04 Client-side restoration successful:",t.name),u(t)):(console.log("⚠️ Saved organization no longer available, clearing storage"),r(null))}}},[j,d,c]),(0,a.useEffect)(()=>{var e;console.log("\uD83D\uDD04 OrganizationContext:",(null==n?void 0:null===(e=n.user)||void 0===e?void 0:e.email)||"no session","[".concat(s,"]")),n&&"authenticated"===s?v():"unauthenticated"===s&&(console.log("\uD83D\uDEAA User logged out - clearing organizations"),g([]),u(null),r(null))},[n,s]);let v=async()=>{try{f(!0),x(null);let e=await fetch("/api/organizations");if(e.ok){let t=(await e.json()).organizations||[];g(t);let n=null,i=o();if(console.log("\uD83D\uDD0D Checking localStorage for saved organization:",i),i&&((n=t.find(e=>e.id===i))?console.log("\uD83C\uDFAF Found matching organization for restoration:",n.name):(console.log("⚠️ Saved organization ID not found in current organizations, clearing localStorage"),r(null))),!n&&t.length>1){console.log("\uD83D\uDD0D Checking for default organization...");try{let e=await fetch("/api/user/default-organization");if(e.ok){let i=await e.json();if(i.hasDefault){let e=t.find(e=>e.id===i.defaultOrganization.id);e&&(n=e,console.log("⭐ Found default organization:",e.name))}}}catch(e){console.error("Error fetching default organization:",e)}}if(n)console.log("✅ Selected organization:",n.name),u(n),r(n.id);else if(1===t.length){let e=t[0];console.log("\uD83D\uDD04 Auto-selecting single organization:",e.name),u(e),r(e.id)}else 0===t.length?(console.log("\uD83D\uDCED No organizations available"),u(null)):console.log("\uD83E\uDD14 Multiple organizations available, waiting for user selection")}else console.error("Failed to fetch organizations:",e.status,e.statusText),x("Failed to fetch organizations"),g([])}catch(e){console.error("Error fetching organizations:",e),x(e.message),g([])}finally{f(!1)}};return(0,i.jsx)(l.Provider,{value:{selectedOrganization:c,organizations:d,loading:h,error:m,selectOrganization:e=>{console.log("\uD83D\uDCBE Selecting organization:",(null==e?void 0:e.name)||"none"),u(e),r((null==e?void 0:e.id)||null)},refreshOrganizations:v,session:n,sessionStatus:s},children:t})}function c(){let e=(0,a.useContext)(l);if(void 0===e)throw Error("useOrganization must be used within an OrganizationProvider");return e}}},function(e){e.O(0,[702,7639,7863,3744,9352,1835,8129,4502,7418,2971,7466,1744],function(){return e(e.s=22756)}),_N_E=e.O()}]);