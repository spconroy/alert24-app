(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4880],{29963:function(e,t,n){Promise.resolve().then(n.bind(n,78604))},78604:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return ee}});var a=n(57437),i=n(2265),r=n(38543),o=n(90658),l=n(19352),s=n(31835),c=n(22347),d=n(9391),u=n(73088),h=n(95280),x=n(33101),m=n(87410),g=n(77639),p=n(61888),j=n(67939),f=n(61587),Z=n(52854),y=n(75263),v=n(50793),b=n(23229),_=n(36261),S=n(67615),D=n(64502),w=n(27554),z=n(88654),C=n(54763),k=n(64703),E=n(42386),O=n(83310),I=n(8319),T=n(7573),B=n(88097),A=n(28852),F=n(49437),M=n(99376),R=n(27648),W=n(51442),N=n(11617),P=n(20599),Y=n(89470),q=n(95488),G=n(27367),U=n(61381),H=n(73546),J=n(71537),L=n(12961),K=n(44812),Q=n(71096),V=n.n(Q),X=n(85744);let $=[{label:"Basic Information",description:"Schedule name and description",icon:(0,a.jsx)(J.Z,{})},{label:"Schedule Configuration",description:"When and how often to rotate",icon:(0,a.jsx)(G.Z,{})},{label:"Team Members",description:"Add responders to rotation",icon:(0,a.jsx)(U.Z,{})},{label:"Settings & Review",description:"Final settings and confirmation",icon:(0,a.jsx)(H.Z,{})}];function ee(){let e=(0,M.useRouter)(),{selectedOrganization:t,session:n}=(0,K.o)(),[G,U]=(0,i.useState)(0),[H,J]=(0,i.useState)({name:"",description:"",start_date:V()().add(1,"hour"),end_date:null,rotation_type:"weekly",rotation_interval_hours:168,rotation_day:1,rotation_time:V()().hour(9).minute(0).second(0),participants:[],is_active:!0,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}),[Q,ee]=(0,i.useState)([]),[et,en]=(0,i.useState)(null),[ea,ei]=(0,i.useState)(!1),[er,eo]=(0,i.useState)(null),[el,es]=(0,i.useState)(!1),[ec,ed]=(0,i.useState)({});(0,i.useEffect)(()=>{(null==t?void 0:t.id)?eu(t.id):(ee([]),J(e=>({...e,participants:[]})))},[t]),(0,i.useEffect)(()=>{let e={daily:24,weekly:168,biweekly:336,monthly:720};e[H.rotation_type]&&J(t=>({...t,rotation_interval_hours:e[H.rotation_type]}))},[H.rotation_type]);let eu=async e=>{try{let t=await fetch("/api/organizations/".concat(e));if(t.ok){let e=await t.json();ee(e.members||[])}}catch(e){console.error("Error fetching organization members:",e)}},eh=e=>{let n={};switch(e){case 0:t||(n.organization="Please select an organization"),H.name.trim()||(n.name="Schedule name is required");break;case 1:H.start_date||(n.start_date="Start date is required"),H.start_date&&H.start_date.isBefore(V()())&&(n.start_date="Start date cannot be in the past"),H.end_date&&H.start_date&&H.end_date.isBefore(H.start_date)&&(n.end_date="End date must be after start date");break;case 2:0===H.participants.length&&(n.participants="At least one participant is required")}return ed(n),0===Object.keys(n).length},ex=async()=>{if(!eh(2)){eo("Please complete all required fields");return}ei(!0),eo(null);try{let n={organization_id:t.id,name:H.name,description:H.description,start_date:H.start_date.toISOString(),end_date:H.end_date?H.end_date.toISOString():null,rotation_type:H.rotation_type,rotation_interval_hours:H.rotation_interval_hours,rotation_day:H.rotation_day,rotation_time:H.rotation_time?{hour:H.rotation_time.hour(),minute:H.rotation_time.minute()}:{hour:9,minute:0},participants:H.participants.map(e=>e.id),timezone:H.timezone,is_active:H.is_active},a=await fetch("/api/on-call-schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!a.ok){let e=await a.json();throw Error(e.error||"Failed to create on-call schedule")}es(!0),setTimeout(()=>{e.push("/on-call")},2e3)}catch(e){console.error("Error creating on-call schedule:",e),eo(e.message)}finally{ei(!1)}},em=(e,t)=>{J(n=>({...n,[e]:t})),ec[e]&&ed(t=>({...t,[e]:""}))},eg=()=>{et&&!H.participants.find(e=>e.id===et.id)&&(J(e=>({...e,participants:[...e.participants,et]})),en(null),ec.participants&&ed(e=>({...e,participants:""})))},ep=e=>{J(t=>({...t,participants:t.participants.filter(t=>t.id!==e)}))},ej=e=>["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e],ef=()=>{let e=H.rotation_time?H.rotation_time.format("h:mm A"):"9:00 AM";switch(H.rotation_type){case"daily":return"Every day at ".concat(e);case"weekly":return"Every ".concat(ej(H.rotation_day)," at ").concat(e);case"biweekly":return"Every other ".concat(ej(H.rotation_day)," at ").concat(e);case"monthly":return"Monthly on the same date at ".concat(e);case"custom":return"Every ".concat(H.rotation_interval_hours," hours");default:return""}};return(0,a.jsx)(X.Z,{children:(0,a.jsx)(A._C,{dateAdapter:F.y,children:(0,a.jsxs)(r.Z,{sx:{p:3},children:[(0,a.jsxs)(r.Z,{display:"flex",alignItems:"center",gap:2,mb:4,children:[(0,a.jsx)(g.Z,{component:R.default,href:"/on-call",startIcon:(0,a.jsx)(W.Z,{}),variant:"outlined",children:"Back to On-Call"}),(0,a.jsx)(o.Z,{variant:"h4",component:"h1",children:"Create On-Call Schedule"})]}),er&&(0,a.jsx)(x.Z,{severity:"error",sx:{mb:3},children:er}),(0,a.jsxs)(l.Z,{container:!0,spacing:4,children:[(0,a.jsx)(l.Z,{item:!0,xs:12,md:4,lg:3,children:(0,a.jsx)(z.Z,{sx:{p:3,position:"sticky",top:20},children:(0,a.jsx)(k.Z,{activeStep:G,orientation:"vertical",children:$.map((e,t)=>(0,a.jsx)(E.Z,{children:(0,a.jsxs)(O.Z,{icon:e.icon,optional:t<G?(0,a.jsx)(L.Z,{sx:{color:"success.main",fontSize:16}}):null,children:[(0,a.jsx)(o.Z,{variant:"subtitle2",children:e.label}),(0,a.jsx)(o.Z,{variant:"caption",color:"text.secondary",children:e.description})]})},e.label))})})}),(0,a.jsx)(l.Z,{item:!0,xs:12,md:8,lg:9,children:(0,a.jsxs)(z.Z,{sx:{p:4},children:[(e=>{switch(e){case 0:return(0,a.jsxs)(r.Z,{children:[(0,a.jsx)(o.Z,{variant:"h5",gutterBottom:!0,children:"Basic Information"}),(0,a.jsx)(o.Z,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Enter the basic details for your on-call schedule"}),(0,a.jsxs)(l.Z,{container:!0,spacing:3,children:[(0,a.jsx)(l.Z,{item:!0,xs:12,children:(0,a.jsx)(s.Z,{label:"Schedule Name",fullWidth:!0,value:H.name,onChange:e=>em("name",e.target.value),error:!!ec.name,helperText:ec.name,placeholder:"e.g., Production Support Team"})}),(0,a.jsx)(l.Z,{item:!0,xs:12,children:(0,a.jsx)(s.Z,{label:"Description",fullWidth:!0,multiline:!0,rows:3,value:H.description,onChange:e=>em("description",e.target.value),placeholder:"Optional description for this schedule"})}),(0,a.jsx)(l.Z,{item:!0,xs:12,children:(0,a.jsx)(s.Z,{label:"Timezone",fullWidth:!0,value:H.timezone,onChange:e=>em("timezone",e.target.value),placeholder:"e.g., America/New_York"})})]})]});case 1:return(0,a.jsxs)(r.Z,{children:[(0,a.jsx)(o.Z,{variant:"h5",gutterBottom:!0,children:"Schedule Configuration"}),(0,a.jsx)(o.Z,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Configure when and how often the schedule should rotate"}),(0,a.jsxs)(l.Z,{container:!0,spacing:3,children:[(0,a.jsx)(l.Z,{item:!0,xs:12,md:6,children:(0,a.jsx)(T.x,{label:"Start Date & Time",value:H.start_date,onChange:e=>em("start_date",e),slotProps:{textField:{fullWidth:!0,error:!!ec.start_date,helperText:ec.start_date}}})}),(0,a.jsx)(l.Z,{item:!0,xs:12,md:6,children:(0,a.jsx)(T.x,{label:"End Date & Time (Optional)",value:H.end_date,onChange:e=>em("end_date",e),slotProps:{textField:{fullWidth:!0,error:!!ec.end_date,helperText:ec.end_date}}})}),(0,a.jsx)(l.Z,{item:!0,xs:12,md:6,children:(0,a.jsxs)(c.Z,{fullWidth:!0,children:[(0,a.jsx)(d.Z,{children:"Rotation Type"}),(0,a.jsxs)(u.Z,{value:H.rotation_type,label:"Rotation Type",onChange:e=>em("rotation_type",e.target.value),children:[(0,a.jsx)(h.Z,{value:"daily",children:"Daily"}),(0,a.jsx)(h.Z,{value:"weekly",children:"Weekly"}),(0,a.jsx)(h.Z,{value:"biweekly",children:"Bi-weekly"}),(0,a.jsx)(h.Z,{value:"monthly",children:"Monthly"})]})]})}),"daily"!==H.rotation_type&&(0,a.jsx)(l.Z,{item:!0,xs:12,md:6,children:(0,a.jsxs)(c.Z,{fullWidth:!0,children:[(0,a.jsx)(d.Z,{children:"Rotation Day"}),(0,a.jsx)(u.Z,{value:H.rotation_day,label:"Rotation Day",onChange:e=>em("rotation_day",e.target.value),children:[0,1,2,3,4,5,6].map(e=>(0,a.jsx)(h.Z,{value:e,children:ej(e)},e))})]})}),(0,a.jsx)(l.Z,{item:!0,xs:12,md:6,children:(0,a.jsx)(B.j,{label:"Rotation Time",value:H.rotation_time,onChange:e=>em("rotation_time",e),slotProps:{textField:{fullWidth:!0}}})}),(0,a.jsx)(l.Z,{item:!0,xs:12,children:(0,a.jsx)(x.Z,{severity:"info",children:(0,a.jsxs)(o.Z,{variant:"body2",children:[(0,a.jsx)("strong",{children:"Rotation Schedule:"})," ",ef()]})})})]})]});case 2:return(0,a.jsxs)(r.Z,{children:[(0,a.jsx)(o.Z,{variant:"h5",gutterBottom:!0,children:"Team Members"}),(0,a.jsx)(o.Z,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Add team members to the on-call rotation"}),ec.participants&&(0,a.jsx)(x.Z,{severity:"error",sx:{mb:2},children:ec.participants}),(0,a.jsxs)(l.Z,{container:!0,spacing:3,children:[(0,a.jsx)(l.Z,{item:!0,xs:12,children:(0,a.jsxs)(r.Z,{display:"flex",gap:2,alignItems:"flex-end",children:[(0,a.jsx)(m.Z,{options:Q.filter(e=>!H.participants.find(t=>t.id===e.id)),getOptionLabel:e=>"".concat(e.name," (").concat(e.email,")"),value:et,onChange:(e,t)=>en(t),sx:{flexGrow:1},renderInput:e=>(0,a.jsx)(s.Z,{...e,label:"Add Team Member",placeholder:"Search for team members..."})}),(0,a.jsx)(g.Z,{variant:"contained",onClick:eg,disabled:!et,startIcon:(0,a.jsx)(Y.Z,{}),children:"Add"})]})}),H.participants.length>0&&(0,a.jsxs)(l.Z,{item:!0,xs:12,children:[(0,a.jsxs)(o.Z,{variant:"h6",sx:{mb:2},children:["Rotation Order (",H.participants.length," members)"]}),(0,a.jsx)(p.Z,{children:H.participants.map((e,t)=>(0,a.jsxs)(j.ZP,{sx:{border:1,borderColor:"divider",borderRadius:1,mb:1},children:[(0,a.jsx)(f.Z,{children:(0,a.jsx)(Z.Z,{children:(0,a.jsx)(q.Z,{})})}),(0,a.jsx)(y.Z,{primary:(0,a.jsxs)(r.Z,{display:"flex",alignItems:"center",gap:1,children:[(0,a.jsx)(v.Z,{label:"#".concat(t+1),size:"small",color:"primary"}),e.name]}),secondary:e.email}),(0,a.jsx)(b.Z,{children:(0,a.jsx)(_.Z,{edge:"end",onClick:()=>ep(e.id),children:(0,a.jsx)(P.Z,{})})})]},e.id))})]})]})]});case 3:var t,n;return(0,a.jsxs)(r.Z,{children:[(0,a.jsx)(o.Z,{variant:"h5",gutterBottom:!0,children:"Settings & Review"}),(0,a.jsx)(o.Z,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Review your schedule configuration and adjust final settings"}),(0,a.jsxs)(l.Z,{container:!0,spacing:3,children:[(0,a.jsx)(l.Z,{item:!0,xs:12,children:(0,a.jsx)(S.Z,{control:(0,a.jsx)(D.Z,{checked:H.is_active,onChange:e=>em("is_active",e.target.checked)}),label:"Activate schedule immediately"})}),(0,a.jsxs)(l.Z,{item:!0,xs:12,children:[(0,a.jsx)(w.Z,{sx:{my:2}}),(0,a.jsx)(o.Z,{variant:"h6",gutterBottom:!0,children:"Schedule Summary"})]}),(0,a.jsx)(l.Z,{item:!0,xs:12,md:6,children:(0,a.jsxs)(z.Z,{sx:{p:2,bgcolor:"grey.50"},children:[(0,a.jsx)(o.Z,{variant:"subtitle2",gutterBottom:!0,children:"Basic Information"}),(0,a.jsxs)(o.Z,{variant:"body2",children:[(0,a.jsx)("strong",{children:"Name:"})," ",H.name]}),(0,a.jsxs)(o.Z,{variant:"body2",children:[(0,a.jsx)("strong",{children:"Description:"})," ",H.description||"None"]}),(0,a.jsxs)(o.Z,{variant:"body2",children:[(0,a.jsx)("strong",{children:"Timezone:"})," ",H.timezone]})]})}),(0,a.jsx)(l.Z,{item:!0,xs:12,md:6,children:(0,a.jsxs)(z.Z,{sx:{p:2,bgcolor:"grey.50"},children:[(0,a.jsx)(o.Z,{variant:"subtitle2",gutterBottom:!0,children:"Schedule Configuration"}),(0,a.jsxs)(o.Z,{variant:"body2",children:[(0,a.jsx)("strong",{children:"Start:"})," ",null===(t=H.start_date)||void 0===t?void 0:t.format("MMM D, YYYY h:mm A")]}),(0,a.jsxs)(o.Z,{variant:"body2",children:[(0,a.jsx)("strong",{children:"End:"})," ",(null===(n=H.end_date)||void 0===n?void 0:n.format("MMM D, YYYY h:mm A"))||"No end date"]}),(0,a.jsxs)(o.Z,{variant:"body2",children:[(0,a.jsx)("strong",{children:"Rotation:"})," ",ef()]})]})}),(0,a.jsx)(l.Z,{item:!0,xs:12,children:(0,a.jsxs)(z.Z,{sx:{p:2,bgcolor:"grey.50"},children:[(0,a.jsxs)(o.Z,{variant:"subtitle2",gutterBottom:!0,children:["Team Members (",H.participants.length,")"]}),(0,a.jsx)(C.Z,{direction:"row",spacing:1,flexWrap:"wrap",useFlexGap:!0,children:H.participants.map((e,t)=>(0,a.jsx)(v.Z,{label:"".concat(t+1,". ").concat(e.name),variant:"outlined"},e.id))})]})}),el&&(0,a.jsx)(l.Z,{item:!0,xs:12,children:(0,a.jsx)(x.Z,{severity:"success",children:"On-call schedule created successfully! Redirecting..."})})]})]});default:return null}})(G),(0,a.jsxs)(r.Z,{sx:{display:"flex",justifyContent:"space-between",mt:4},children:[(0,a.jsx)(g.Z,{disabled:0===G,onClick:()=>{U(e=>e-1)},variant:"outlined",children:"Back"}),(0,a.jsxs)(r.Z,{display:"flex",gap:2,children:[(0,a.jsx)(g.Z,{component:R.default,href:"/on-call",variant:"outlined",color:"inherit",children:"Cancel"}),G===$.length-1?(0,a.jsx)(g.Z,{variant:"contained",onClick:ex,disabled:ea,startIcon:ea?(0,a.jsx)(I.Z,{size:20}):(0,a.jsx)(N.Z,{}),children:ea?"Creating...":"Create Schedule"}):(0,a.jsx)(g.Z,{variant:"contained",onClick:()=>{eh(G)&&U(e=>e+1)},children:"Next"})]})]})]})})]})]})})})}},85744:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});var a=n(57437),i=n(2265),r=n(8319),o=n(38543),l=n(44812);function s(e){let{children:t}=e,{session:n,sessionStatus:s}=(0,l.o)();return((0,i.useEffect)(()=>{"unauthenticated"===s&&(window.location.href="/api/auth/signin")},[s]),"loading"===s)?(0,a.jsx)(o.Z,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"50vh",children:(0,a.jsx)(r.Z,{})}):n?t:null}},44812:function(e,t,n){"use strict";n.d(t,{f:function(){return s},o:function(){return c}});var a=n(57437),i=n(2265);let r=(0,i.createContext)(),o=()=>{try{if(window.localStorage)return localStorage.getItem("selectedOrganizationId")}catch(e){console.warn("Failed to read from localStorage:",e)}return null},l=e=>{try{if(window.localStorage){if(e)return localStorage.setItem("selectedOrganizationId",e),console.log("✅ Saved to localStorage:",e),!0;return localStorage.removeItem("selectedOrganizationId"),console.log("\uD83D\uDDD1️ Removed from localStorage"),!0}}catch(e){console.warn("Failed to write to localStorage:",e)}return!1};function s(e){let{children:t}=e,{data:n,status:s}=function(){let[e,t]=(0,i.useState)(null),[n,a]=(0,i.useState)("loading");return(0,i.useEffect)(()=>{let e=async()=>{try{a("loading");let e=await fetch("/api/auth/session");if(e.ok){let n=await e.json();t(n),a(n?"authenticated":"unauthenticated")}else t(null),a("unauthenticated")}catch(e){console.error("Error fetching session:",e),t(null),a("unauthenticated")}};e();let n=setInterval(e,3e5);return()=>clearInterval(n)},[]),{data:e,status:n}}(),[c,d]=(0,i.useState)(null),[u,h]=(0,i.useState)([]),[x,m]=(0,i.useState)(!1),[g,p]=(0,i.useState)(null),[j,f]=(0,i.useState)(!1);(0,i.useEffect)(()=>{f(!0)},[]),(0,i.useEffect)(()=>{if(j&&u.length>0&&!c){console.log("\uD83D\uDD0D Client-side restoration check...");let e=o();if(e){let t=u.find(t=>t.id===e);t?(console.log("\uD83D\uDD04 Client-side restoration successful:",t.name),d(t)):(console.log("⚠️ Saved organization no longer available, clearing storage"),l(null))}}},[j,u,c]),(0,i.useEffect)(()=>{var e;console.log("\uD83D\uDD04 OrganizationContext:",(null==n?void 0:null===(e=n.user)||void 0===e?void 0:e.email)||"no session","[".concat(s,"]")),n&&"authenticated"===s?Z():"unauthenticated"===s&&(console.log("\uD83D\uDEAA User logged out - clearing organizations"),h([]),d(null),l(null))},[n,s]);let Z=async()=>{try{m(!0),p(null);let e=await fetch("/api/organizations");if(e.ok){let t=(await e.json()).organizations||[];h(t);let n=null,a=o();if(console.log("\uD83D\uDD0D Checking localStorage for saved organization:",a),a&&((n=t.find(e=>e.id===a))?console.log("\uD83C\uDFAF Found matching organization for restoration:",n.name):(console.log("⚠️ Saved organization ID not found in current organizations, clearing localStorage"),l(null))),!n&&t.length>1){console.log("\uD83D\uDD0D Checking for default organization...");try{let e=await fetch("/api/user/default-organization");if(e.ok){let a=await e.json();if(a.hasDefault){let e=t.find(e=>e.id===a.defaultOrganization.id);e&&(n=e,console.log("⭐ Found default organization:",e.name))}}}catch(e){console.error("Error fetching default organization:",e)}}if(n)console.log("✅ Selected organization:",n.name),d(n),l(n.id);else if(1===t.length){let e=t[0];console.log("\uD83D\uDD04 Auto-selecting single organization:",e.name),d(e),l(e.id)}else 0===t.length?(console.log("\uD83D\uDCED No organizations available"),d(null)):console.log("\uD83E\uDD14 Multiple organizations available, waiting for user selection")}else console.error("Failed to fetch organizations:",e.status,e.statusText),p("Failed to fetch organizations"),h([])}catch(e){console.error("Error fetching organizations:",e),p(e.message),h([])}finally{m(!1)}};return(0,a.jsx)(r.Provider,{value:{selectedOrganization:c,organizations:u,loading:x,error:g,selectOrganization:e=>{console.log("\uD83D\uDCBE Selecting organization:",(null==e?void 0:e.name)||"none"),d(e),l((null==e?void 0:e.id)||null)},refreshOrganizations:Z,session:n,sessionStatus:s},children:t})}function c(){let e=(0,i.useContext)(r);if(void 0===e)throw Error("useOrganization must be used within an OrganizationProvider");return e}}},function(e){e.O(0,[702,7639,7863,3744,793,9352,1835,8129,7286,4045,9815,4502,9458,2982,8520,2812,2971,7466,1744],function(){return e(e.s=29963)}),_N_E=e.O()}]);