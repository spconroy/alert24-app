(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8061],{94836:function(e,t,n){Promise.resolve().then(n.bind(n,22815))},22815:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return W},runtime:function(){return A}});var a=n(57437),i=n(2265),o=n(38543),r=n(8319),l=n(77639),s=n(90658),c=n(33101),d=n(41563),u=n(61002),h=n(19352),m=n(31835),f=n(67615),g=n(64502),x=n(27554),p=n(22347),_=n(9391),v=n(73088),j=n(95280),Z=n(87410),y=n(61888),D=n(67939),S=n(75263),b=n(50793),C=n(23229),w=n(36261),z=n(7573),E=n(99376),k=n(27648),I=n(51442),O=n(11617),P=n(20599),R=n(89470),T=n(95488),F=n(44812),M=n(71096),B=n.n(M),N=n(85744);let A="edge";function W(){let e=(0,E.useRouter)(),t=(0,E.useParams)().id,{session:n,selectedOrganization:M}=(0,F.o)(),[A,W]=(0,i.useState)({name:"",description:"",start_date:B()(),end_date:null,rotation_type:"weekly",rotation_interval_hours:168,rotation_day:1,rotation_time:B()().hour(9).minute(0).second(0),participants:[],is_active:!0,timezone:"UTC"}),[U,q]=(0,i.useState)(null),[H,J]=(0,i.useState)([]),[L,G]=(0,i.useState)(null),[K,Q]=(0,i.useState)(!0),[V,X]=(0,i.useState)(!1),[Y,$]=(0,i.useState)(null),[ee,et]=(0,i.useState)(!1),[en,ea]=(0,i.useState)({});(0,i.useEffect)(()=>{t&&n&&ei()},[t,n]),(0,i.useEffect)(()=>{(null==M?void 0:M.id)&&eo(M.id)},[M]);let ei=async()=>{try{Q(!0);let e=await fetch("/api/on-call-schedules/".concat(t));if(!e.ok)throw Error("Failed to fetch schedule");let n=(await e.json()).schedule;q(n);let a={};try{a=n.rotation_config?"string"==typeof n.rotation_config?JSON.parse(n.rotation_config):n.rotation_config:{}}catch(e){console.warn("Failed to parse rotation config:",e),a={}}let i=[];try{i=n.members?"string"==typeof n.members?JSON.parse(n.members):n.members:[]}catch(e){console.warn("Failed to parse members:",e),i=[]}W({name:n.name||"",description:n.description||"",start_date:a.start_date?B()(a.start_date):B()(),end_date:a.end_date?B()(a.end_date):null,rotation_type:a.rotation_type||n.schedule_type||"weekly",rotation_interval_hours:a.rotation_interval_hours||168,rotation_day:a.rotation_day||1,rotation_time:a.rotation_time?B()().hour(a.rotation_time.hour||9).minute(a.rotation_time.minute||0):B()().hour(9).minute(0),participants:i,is_active:n.is_active||!1,timezone:a.timezone||n.timezone||"UTC"})}catch(e){console.error("Error fetching schedule:",e),$(e.message)}finally{Q(!1)}},eo=async e=>{try{let t=await fetch("/api/organizations/".concat(e));if(t.ok){let e=await t.json();J(e.members||[])}}catch(e){console.error("Error fetching organization members:",e)}},er=()=>{let e={};return A.name.trim()||(e.name="Schedule name is required"),A.start_date||(e.start_date="Start date is required"),A.end_date&&A.start_date&&A.end_date.isBefore(A.start_date)&&(e.end_date="End date must be after start date"),A.rotation_interval_hours<1&&(e.rotation_interval_hours="Rotation interval must be at least 1 hour"),ea(e),0===Object.keys(e).length},el=async n=>{if(n.preventDefault(),!er()){$("Please fix the form errors before submitting");return}X(!0),$(null);try{let n={name:A.name,description:A.description,is_active:A.is_active,members:A.participants,rotation_config:{rotation_type:A.rotation_type,rotation_interval_hours:A.rotation_interval_hours,rotation_day:A.rotation_day,rotation_time:A.rotation_time?{hour:A.rotation_time.hour(),minute:A.rotation_time.minute()}:{hour:9,minute:0},timezone:A.timezone,start_date:A.start_date.toISOString(),end_date:A.end_date?A.end_date.toISOString():null}},a=await fetch("/api/on-call-schedules/".concat(t),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!a.ok){let e=await a.json();throw Error(e.error||"Failed to update schedule")}et(!0),setTimeout(()=>{e.push("/on-call")},1e3)}catch(e){console.error("Error updating schedule:",e),$(e.message)}finally{X(!1)}},es=(e,t)=>{W(n=>({...n,[e]:t})),en[e]&&ea(t=>({...t,[e]:void 0}))},ec=e=>{W(t=>({...t,participants:t.participants.filter(t=>t.id!==e)}))};return(0,a.jsx)(N.Z,{children:K?(0,a.jsx)(o.Z,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:(0,a.jsx)(r.Z,{})}):(0,a.jsxs)(o.Z,{sx:{p:3},children:[(0,a.jsxs)(o.Z,{display:"flex",alignItems:"center",gap:2,mb:4,children:[(0,a.jsx)(l.Z,{component:k.default,href:"/on-call",startIcon:(0,a.jsx)(I.Z,{}),variant:"outlined",children:"Back to On-Call"}),(0,a.jsx)(s.Z,{variant:"h4",component:"h1",children:"Edit On-Call Schedule"})]}),Y&&(0,a.jsx)(c.Z,{severity:"error",sx:{mb:2},children:Y}),ee&&(0,a.jsx)(c.Z,{severity:"success",sx:{mb:2},children:"Schedule updated successfully! Redirecting..."}),(0,a.jsx)(d.Z,{children:(0,a.jsx)(u.Z,{children:(0,a.jsx)("form",{onSubmit:el,children:(0,a.jsxs)(h.Z,{container:!0,spacing:3,children:[(0,a.jsx)(h.Z,{item:!0,xs:12,children:(0,a.jsx)(s.Z,{variant:"h6",gutterBottom:!0,children:"Basic Information"})}),(0,a.jsx)(h.Z,{item:!0,xs:12,md:6,children:(0,a.jsx)(m.Z,{fullWidth:!0,label:"Schedule Name",value:A.name,onChange:e=>es("name",e.target.value),error:!!en.name,helperText:en.name,required:!0})}),(0,a.jsx)(h.Z,{item:!0,xs:12,md:6,children:(0,a.jsx)(f.Z,{control:(0,a.jsx)(g.Z,{checked:A.is_active,onChange:e=>es("is_active",e.target.checked),color:"primary"}),label:"Active"})}),(0,a.jsx)(h.Z,{item:!0,xs:12,children:(0,a.jsx)(m.Z,{fullWidth:!0,label:"Description",value:A.description,onChange:e=>es("description",e.target.value),multiline:!0,rows:3})}),(0,a.jsxs)(h.Z,{item:!0,xs:12,children:[(0,a.jsx)(x.Z,{sx:{my:2}}),(0,a.jsx)(s.Z,{variant:"h6",gutterBottom:!0,children:"Rotation Settings"})]}),(0,a.jsx)(h.Z,{item:!0,xs:12,md:6,children:(0,a.jsxs)(p.Z,{fullWidth:!0,children:[(0,a.jsx)(_.Z,{children:"Rotation Type"}),(0,a.jsxs)(v.Z,{value:A.rotation_type,onChange:e=>es("rotation_type",e.target.value),label:"Rotation Type",children:[(0,a.jsx)(j.Z,{value:"daily",children:"Daily"}),(0,a.jsx)(j.Z,{value:"weekly",children:"Weekly"}),(0,a.jsx)(j.Z,{value:"biweekly",children:"Bi-weekly"}),(0,a.jsx)(j.Z,{value:"monthly",children:"Monthly"})]})]})}),(0,a.jsx)(h.Z,{item:!0,xs:12,md:6,children:(0,a.jsx)(m.Z,{fullWidth:!0,label:"Rotation Interval (hours)",type:"number",value:A.rotation_interval_hours,onChange:e=>es("rotation_interval_hours",parseInt(e.target.value)||0),error:!!en.rotation_interval_hours,helperText:en.rotation_interval_hours,inputProps:{min:1}})}),(0,a.jsx)(h.Z,{item:!0,xs:12,md:6,children:(0,a.jsx)(z.x,{label:"Start Date",value:A.start_date,onChange:e=>es("start_date",e),renderInput:e=>(0,a.jsx)(m.Z,{...e,fullWidth:!0,error:!!en.start_date,helperText:en.start_date})})}),(0,a.jsx)(h.Z,{item:!0,xs:12,md:6,children:(0,a.jsx)(z.x,{label:"End Date (Optional)",value:A.end_date,onChange:e=>es("end_date",e),renderInput:e=>(0,a.jsx)(m.Z,{...e,fullWidth:!0,error:!!en.end_date,helperText:en.end_date})})}),(0,a.jsxs)(h.Z,{item:!0,xs:12,children:[(0,a.jsx)(x.Z,{sx:{my:2}}),(0,a.jsx)(s.Z,{variant:"h6",gutterBottom:!0,children:"Participants"})]}),(0,a.jsx)(h.Z,{item:!0,xs:12,md:8,children:(0,a.jsx)(Z.Z,{options:H,getOptionLabel:e=>"".concat(e.name||e.email," (").concat(e.email,")"),value:L,onChange:(e,t)=>G(t),renderInput:e=>(0,a.jsx)(m.Z,{...e,label:"Add Team Member",placeholder:"Select a team member to add to rotation"})})}),(0,a.jsx)(h.Z,{item:!0,xs:12,md:4,children:(0,a.jsx)(l.Z,{fullWidth:!0,variant:"outlined",onClick:()=>{L&&!A.participants.find(e=>e.id===L.id)&&(W(e=>({...e,participants:[...e.participants,L]})),G(null))},disabled:!L,startIcon:(0,a.jsx)(R.Z,{}),sx:{height:"56px"},children:"Add Member"})}),A.participants.length>0&&(0,a.jsxs)(h.Z,{item:!0,xs:12,children:[(0,a.jsxs)(s.Z,{variant:"subtitle1",gutterBottom:!0,children:["Rotation Order (",A.participants.length," members)"]}),(0,a.jsx)(y.Z,{children:A.participants.map((e,t)=>(0,a.jsxs)(D.ZP,{divider:!0,children:[(0,a.jsx)(S.Z,{primary:(0,a.jsxs)(o.Z,{display:"flex",alignItems:"center",gap:1,children:[(0,a.jsx)(b.Z,{label:t+1,size:"small",color:"primary",variant:"outlined"}),(0,a.jsx)(T.Z,{color:"action"}),e.name||e.email]}),secondary:e.email}),(0,a.jsx)(C.Z,{children:(0,a.jsx)(w.Z,{edge:"end",onClick:()=>ec(e.id),color:"error",children:(0,a.jsx)(P.Z,{})})})]},e.id))})]}),(0,a.jsxs)(h.Z,{item:!0,xs:12,children:[(0,a.jsx)(x.Z,{sx:{my:2}}),(0,a.jsxs)(o.Z,{display:"flex",gap:2,justifyContent:"flex-end",children:[(0,a.jsx)(l.Z,{component:k.default,href:"/on-call",variant:"outlined",disabled:V,children:"Cancel"}),(0,a.jsx)(l.Z,{type:"submit",variant:"contained",disabled:V,startIcon:V?(0,a.jsx)(r.Z,{size:20}):(0,a.jsx)(O.Z,{}),children:V?"Updating...":"Update Schedule"})]})]})]})})})})]})})}},85744:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});var a=n(57437),i=n(2265),o=n(8319),r=n(38543),l=n(44812);function s(e){let{children:t}=e,{session:n,sessionStatus:s}=(0,l.o)();return((0,i.useEffect)(()=>{"unauthenticated"===s&&(window.location.href="/api/auth/signin")},[s]),"loading"===s)?(0,a.jsx)(r.Z,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"50vh",children:(0,a.jsx)(o.Z,{})}):n?t:null}},44812:function(e,t,n){"use strict";n.d(t,{f:function(){return s},o:function(){return c}});var a=n(57437),i=n(2265);let o=(0,i.createContext)(),r=()=>{try{if(window.localStorage)return localStorage.getItem("selectedOrganizationId")}catch(e){console.warn("Failed to read from localStorage:",e)}return null},l=e=>{try{if(window.localStorage){if(e)return localStorage.setItem("selectedOrganizationId",e),console.log("✅ Saved to localStorage:",e),!0;return localStorage.removeItem("selectedOrganizationId"),console.log("\uD83D\uDDD1️ Removed from localStorage"),!0}}catch(e){console.warn("Failed to write to localStorage:",e)}return!1};function s(e){let{children:t}=e,{data:n,status:s}=function(){let[e,t]=(0,i.useState)(null),[n,a]=(0,i.useState)("loading");return(0,i.useEffect)(()=>{let e=async()=>{try{a("loading");let e=await fetch("/api/auth/session");if(e.ok){let n=await e.json();t(n),a(n?"authenticated":"unauthenticated")}else t(null),a("unauthenticated")}catch(e){console.error("Error fetching session:",e),t(null),a("unauthenticated")}};e();let n=setInterval(e,3e5);return()=>clearInterval(n)},[]),{data:e,status:n}}(),[c,d]=(0,i.useState)(null),[u,h]=(0,i.useState)([]),[m,f]=(0,i.useState)(!1),[g,x]=(0,i.useState)(null),[p,_]=(0,i.useState)(!1);(0,i.useEffect)(()=>{_(!0)},[]),(0,i.useEffect)(()=>{if(p&&u.length>0&&!c){console.log("\uD83D\uDD0D Client-side restoration check...");let e=r();if(e){let t=u.find(t=>t.id===e);t?(console.log("\uD83D\uDD04 Client-side restoration successful:",t.name),d(t)):(console.log("⚠️ Saved organization no longer available, clearing storage"),l(null))}}},[p,u,c]),(0,i.useEffect)(()=>{var e;console.log("\uD83D\uDD04 OrganizationContext:",(null==n?void 0:null===(e=n.user)||void 0===e?void 0:e.email)||"no session","[".concat(s,"]")),n&&"authenticated"===s?v():"unauthenticated"===s&&(console.log("\uD83D\uDEAA User logged out - clearing organizations"),h([]),d(null),l(null))},[n,s]);let v=async()=>{try{f(!0),x(null);let e=await fetch("/api/organizations");if(e.ok){let t=(await e.json()).organizations||[];h(t);let n=null,a=r();if(console.log("\uD83D\uDD0D Checking localStorage for saved organization:",a),a&&((n=t.find(e=>e.id===a))?console.log("\uD83C\uDFAF Found matching organization for restoration:",n.name):(console.log("⚠️ Saved organization ID not found in current organizations, clearing localStorage"),l(null))),!n&&t.length>1){console.log("\uD83D\uDD0D Checking for default organization...");try{let e=await fetch("/api/user/default-organization");if(e.ok){let a=await e.json();if(a.hasDefault){let e=t.find(e=>e.id===a.defaultOrganization.id);e&&(n=e,console.log("⭐ Found default organization:",e.name))}}}catch(e){console.error("Error fetching default organization:",e)}}if(n)console.log("✅ Selected organization:",n.name),d(n),l(n.id);else if(1===t.length){let e=t[0];console.log("\uD83D\uDD04 Auto-selecting single organization:",e.name),d(e),l(e.id)}else 0===t.length?(console.log("\uD83D\uDCED No organizations available"),d(null)):console.log("\uD83E\uDD14 Multiple organizations available, waiting for user selection")}else console.error("Failed to fetch organizations:",e.status,e.statusText),x("Failed to fetch organizations"),h([])}catch(e){console.error("Error fetching organizations:",e),x(e.message),h([])}finally{f(!1)}};return(0,a.jsx)(o.Provider,{value:{selectedOrganization:c,organizations:u,loading:m,error:g,selectOrganization:e=>{console.log("\uD83D\uDCBE Selecting organization:",(null==e?void 0:e.name)||"none"),d(e),l((null==e?void 0:e.id)||null)},refreshOrganizations:v,session:n,sessionStatus:s},children:t})}function c(){let e=(0,i.useContext)(o);if(void 0===e)throw Error("useOrganization must be used within an OrganizationProvider");return e}},41563:function(e,t,n){"use strict";n.d(t,{Z:function(){return g}});var a=n(2265),i=n(61994),o=n(7609),r=n(1589),l=n(42318),s=n(88654),c=n(15245),d=n(11475);function u(e){return(0,d.ZP)("MuiCard",e)}(0,c.Z)("MuiCard",["root"]);var h=n(57437);let m=e=>{let{classes:t}=e;return(0,o.Z)({root:["root"]},u,t)},f=(0,r.ZP)(s.Z,{name:"MuiCard",slot:"Root"})({overflow:"hidden"});var g=a.forwardRef(function(e,t){let n=(0,l.i)({props:e,name:"MuiCard"}),{className:a,raised:o=!1,...r}=n,s={...n,raised:o},c=m(s);return(0,h.jsx)(f,{className:(0,i.Z)(c.root,a),elevation:o?8:void 0,ref:t,ownerState:s,...r})})},61002:function(e,t,n){"use strict";n.d(t,{Z:function(){return f}});var a=n(2265),i=n(61994),o=n(7609),r=n(1589),l=n(42318),s=n(15245),c=n(11475);function d(e){return(0,c.ZP)("MuiCardContent",e)}(0,s.Z)("MuiCardContent",["root"]);var u=n(57437);let h=e=>{let{classes:t}=e;return(0,o.Z)({root:["root"]},d,t)},m=(0,r.ZP)("div",{name:"MuiCardContent",slot:"Root"})({padding:16,"&:last-child":{paddingBottom:24}});var f=a.forwardRef(function(e,t){let n=(0,l.i)({props:e,name:"MuiCardContent"}),{className:a,component:o="div",...r}=n,s={...n,component:o},c=h(s);return(0,u.jsx)(m,{as:o,className:(0,i.Z)(c.root,a),ownerState:s,ref:t,...r})})}},function(e){e.O(0,[702,7639,7863,3744,793,9352,1835,8129,7286,4045,9815,4502,9458,2982,8520,2971,7466,1744],function(){return e(e.s=94836)}),_N_E=e.O()}]);